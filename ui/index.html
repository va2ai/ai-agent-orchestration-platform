<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roundtable | AI Refinement</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/css/styles.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            900: '#0c4a6e',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-50 dark:bg-slate-950 text-slate-800 dark:text-slate-200 font-sans h-screen flex overflow-hidden transition-colors duration-200">
    <script>
        document.body.setAttribute('data-date', new Date().toLocaleDateString());
    </script>
    <!-- Sidebar -->
    <aside class="w-64 bg-slate-900 dark:bg-slate-950 text-white flex flex-col shadow-2xl z-10 border-r border-slate-800 dark:border-slate-900">
        <!-- Brand -->
        <div class="p-6 border-b border-slate-800 dark:border-slate-900 flex items-center gap-3">
            <div class="w-8 h-8 bg-brand-500 rounded-lg flex items-center justify-center text-white font-bold text-lg">
                <i class="fa-solid fa-layer-group"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg tracking-tight">Roundtable</h1>
                <p class="text-xs text-slate-400">AI Collaboration</p>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 overflow-y-auto p-4 space-y-2">
            <button onclick="showView('setupView')" class="w-full flex items-center gap-3 px-4 py-3 text-left rounded-lg hover:bg-slate-800 dark:hover:bg-slate-900 transition text-sm font-medium">
                <i class="fa-solid fa-plus text-brand-500"></i> New Session
            </button>
            
            <div class="mt-6">
                <h3 class="px-4 text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">History</h3>
                <div id="sessionList" class="space-y-1">
                    <!-- Session items injected here -->
                    <div class="px-4 py-2 text-xs text-slate-500 italic">Loading sessions...</div>
                </div>
            </div>
        </nav>

        <!-- User Profile (Static) -->
        <div class="p-4 border-t border-slate-800 dark:border-slate-900">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-xs">AI</div>
                    <div class="text-sm">
                        <p class="font-medium">User</p>
                        <p class="text-xs text-slate-400">Standard Plan</p>
                    </div>
                </div>
                <button onclick="toggleDarkMode()" class="text-slate-400 hover:text-white transition p-2 rounded-lg hover:bg-slate-800" title="Toggle Dark Mode">
                    <i class="fa-solid fa-moon dark:hidden"></i>
                    <i class="fa-solid fa-sun hidden dark:inline"></i>
                </button>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full relative overflow-hidden">
        
        <!-- Views Container -->
        <div class="flex-1 overflow-y-auto bg-gray-50 dark:bg-slate-950 relative p-8 transition-colors duration-200">

            <!-- VIEW: SETUP (New Session) -->
            <div id="setupView" class="max-w-4xl mx-auto animate-fade-in">
                <div class="mb-8 text-center">
                    <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-2">Start a New Roundtable</h2>
                    <p class="text-slate-500 dark:text-slate-400">Assemble a team of AI experts to refine your document.</p>
                </div>

                <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-sm border border-gray-200 dark:border-slate-800 overflow-hidden transition-colors duration-200">
                    <div class="p-8">
                        <form id="startForm" class="space-y-6">
                            
                            <!-- Top Row -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Topic / Title</label>
                                    <input type="text" id="title" class="w-full border-gray-200 dark:border-slate-700 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 transition px-4 py-3 text-sm bg-gray-50 dark:bg-slate-800 dark:text-white" required placeholder="e.g., AI Chatbot Feature">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Document Type</label>
                                    <div class="relative">
                                        <select id="documentType" class="w-full border-gray-200 dark:border-slate-700 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 transition px-4 py-3 text-sm bg-gray-50 dark:bg-slate-800 dark:text-white appearance-none">
                                            <option value="document">General Document</option>
                                            <option value="prd">Product Requirements (PRD)</option>
                                            <option value="code-review">Code Review</option>
                                            <option value="architecture">System Architecture</option>
                                            <option value="business-strategy">Business Strategy</option>
                                        </select>
                                        <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-gray-500">
                                            <i class="fa-solid fa-chevron-down text-xs"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Goal -->
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Refinement Goal <span class="text-gray-400 font-normal">(Optional)</span></label>
                                <input type="text" id="goal" class="w-full border-gray-200 dark:border-slate-700 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 transition px-4 py-3 text-sm bg-gray-50 dark:bg-slate-800 dark:text-white" placeholder="e.g., improve security, clarify edge cases...">
                            </div>

                            <!-- Content Area -->
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300">Initial Content</label>
                                    <div class="flex items-center gap-2">
                                        <span id="uploadStatus" class="text-xs hidden"></span>
                                        <label for="fileUpload" class="cursor-pointer text-xs font-medium text-brand-600 hover:text-brand-800 transition flex items-center gap-1">
                                            <i class="fa-solid fa-cloud-arrow-up"></i> Upload File
                                        </label>
                                        <input type="file" id="fileUpload" class="hidden" accept=".txt,.md,.pdf,.docx">
                                        <button type="button" id="uploadButton" class="hidden"></button> <!-- Hidden trigger for logic -->
                                    </div>
                                </div>
                                <textarea id="content" rows="12" class="w-full border-gray-200 dark:border-slate-700 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 transition px-4 py-3 font-mono text-sm bg-gray-50 dark:bg-slate-800 dark:text-white leading-relaxed" required placeholder="# Write or paste your content here..."></textarea>
                            </div>

                            <!-- Advanced Settings (Collapsible) -->
                            <details class="group">
                                <summary class="flex items-center gap-2 cursor-pointer text-sm font-medium text-slate-500 hover:text-brand-600 transition list-none">
                                    <i class="fa-solid fa-sliders group-open:rotate-90 transition-transform"></i> Advanced Settings
                                </summary>
                                <div class="mt-4 p-4 bg-gray-50 dark:bg-slate-800 rounded-lg border border-gray-100 dark:border-slate-700 grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-xs font-semibold text-gray-500 dark:text-gray-400 mb-1">Participants</label>
                                        <input type="number" id="numParticipants" value="3" min="2" max="6" class="w-full border-gray-200 dark:border-slate-700 dark:bg-slate-900 dark:text-white rounded px-2 py-1 text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-semibold text-gray-500 dark:text-gray-400 mb-1">Iterations</label>
                                        <input type="number" id="maxIterations" value="3" min="1" max="10" class="w-full border-gray-200 dark:border-slate-700 dark:bg-slate-900 dark:text-white rounded px-2 py-1 text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-semibold text-gray-500 dark:text-gray-400 mb-1">Preset Template</label>
                                        <select id="usePreset" class="w-full border-gray-200 dark:border-slate-700 dark:bg-slate-900 dark:text-white rounded px-2 py-1 text-sm">
                                            <option value="">Auto (AI Selection)</option>
                                            <option value="prd">PRD Standard</option>
                                            <option value="code-review">Code Review</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-semibold text-gray-500 dark:text-gray-400 mb-1">Participant Style</label>
                                        <select id="participantStyle" class="w-full border-gray-200 dark:border-slate-700 dark:bg-slate-900 dark:text-white rounded px-2 py-1 text-sm">
                                            <option value="">Balanced (Default)</option>
                                            <option value="critical">Critical / Harsh</option>
                                            <option value="creative">Creative / Visionary</option>
                                            <option value="conservative">Conservative / Risk-Averse</option>
                                            <option value="academic">Academic / Formal</option>
                                            <option value="custom">Custom...</option>
                                        </select>
                                        <input type="text" id="customStyleInput" class="hidden w-full mt-2 border-gray-200 dark:border-slate-700 rounded px-2 py-1 text-sm bg-gray-50 dark:bg-slate-800 dark:text-white" placeholder="e.g. Sarcastic, 5-year-old, Pirate...">
                                    </div>
                                    <div class="md:col-span-3 mt-2 grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-xs font-semibold text-gray-500 dark:text-gray-400 mb-1">Primary Model</label>
                                            <select id="aiModel" class="w-full border-gray-200 dark:border-slate-700 dark:bg-slate-900 dark:text-white rounded px-2 py-1 text-sm font-mono text-xs">
                                                <optgroup label="Google Gemini">
                                                    <option value="gemini-3-pro-preview" selected>Gemini 3 Pro (Recommended)</option>
                                                    <option value="gemini-3-flash-preview">Gemini 3 Flash (Preview)</option>
                                                    <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                                                    <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                                                    <option value="gemini-flash-latest">Gemini Flash (Latest)</option>
                                                    <option value="gemini-pro-latest">Gemini Pro (Latest)</option>
                                                    <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                                                    <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                                                </optgroup>
                                                <optgroup label="OpenAI GPT-5">
                                                    <option value="gpt-5.2">GPT-5.2</option>
                                                    <option value="gpt-5.2-pro">GPT-5.2 Pro</option>
                                                    <option value="gpt-5">GPT-5</option>
                                                    <option value="gpt-5-mini">GPT-5 Mini</option>
                                                    <option value="gpt-5-nano">GPT-5 Nano</option>
                                                </optgroup>
                                                <optgroup label="OpenAI GPT-4">
                                                    <option value="gpt-4.1">GPT-4.1</option>
                                                    <option value="gpt-4o">GPT-4o</option>
                                                    <option value="gpt-4-turbo">GPT-4 Turbo</option>
                                                </optgroup>
                                                <optgroup label="Anthropic Claude">
                                                    <option value="claude-3-5-sonnet-20240620">Claude 3.5 Sonnet</option>
                                                    <option value="claude-3-opus-20240229">Claude 3 Opus</option>
                                                </optgroup>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-semibold text-gray-500 dark:text-gray-400 mb-1">Model Strategy</label>
                                            <select id="modelStrategy" class="w-full border-gray-200 dark:border-slate-700 dark:bg-slate-900 dark:text-white rounded px-2 py-1 text-sm">
                                                <option value="uniform">Uniform (Use Primary)</option>
                                                <option value="diverse">Diverse (Mix Models)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="md:col-span-3 flex items-center gap-2">
                                        <input type="checkbox" id="forceMaxIterations" class="w-4 h-4 text-brand-600 border-gray-300 dark:border-slate-700 rounded focus:ring-brand-500 dark:bg-slate-900">
                                        <label for="forceMaxIterations" class="text-xs font-medium text-slate-600 dark:text-slate-400">Force Max Iterations (Ignore early convergence)</label>
                                    </div>
                                </div>
                            </details>

                            <!-- Action -->
                            <button type="submit" id="startButton" class="w-full bg-brand-600 hover:bg-brand-700 text-white font-semibold py-4 rounded-lg shadow-lg shadow-brand-500/30 transition-all transform hover:-translate-y-0.5 flex items-center justify-center gap-2">
                                <i class="fa-solid fa-wand-magic-sparkles"></i>
                                <span>Generate Roundtable & Start Refinement</span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- VIEW: MONITOR (Running) -->
            <div id="monitorView" class="hidden h-full flex flex-col">
                <!-- Status Bar -->
                <div id="statusCard" class="bg-white dark:bg-slate-900 border-b border-gray-200 dark:border-slate-800 px-6 py-4 flex items-center justify-between sticky top-0 z-10 transition-colors duration-200">
                    <div>
                        <h2 class="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2">
                            <span id="monitorTitle">Refinement Session</span>
                            <span id="statusBadge" class="px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">Running</span>
                        </h2>
                        <div class="text-xs text-slate-500 dark:text-slate-400 mt-1 flex items-center gap-4">
                            <span><i class="fa-solid fa-arrows-rotate"></i> Iteration <span id="currentIteration">0</span>/<span id="maxIterationDisplay">3</span></span>
                            <span><i class="fa-solid fa-triangle-exclamation"></i> <span id="highIssues">0</span> High Issues</span>
                        </div>
                    </div>
                    <div class="w-1/3">
                         <div class="flex justify-between text-xs mb-1 font-medium text-slate-500 dark:text-slate-400">
                            <span>Progress</span>
                            <span id="progressPercent">0%</span>
                        </div>
                        <div class="w-full bg-gray-100 dark:bg-slate-800 rounded-full h-2 overflow-hidden">
                            <div id="progressBar" class="bg-brand-500 h-2 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Roundtable Visualization -->
                <div id="roundtableContainer" class="bg-slate-900 dark:bg-slate-950 border-b border-gray-800 p-6 flex-shrink-0 relative overflow-hidden hidden transition-all duration-500 ease-in-out" style="min-height: 280px;">
                    <!-- Background / Table Effect -->
                    <div class="absolute inset-0 bg-slate-900 dark:bg-slate-950">
                         <div class="absolute inset-x-0 bottom-0 h-1/2 bg-gradient-to-t from-slate-900/50 to-transparent pointer-events-none"></div>
                         <!-- Central Table Graphic -->
                         <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[600px] h-[300px] bg-slate-800/50 rounded-[50%] border-2 border-slate-700/50 blur-[1px] transform scale-y-75 shadow-2xl"></div>
                    </div>

                    <!-- Participants Grid -->
                    <div class="relative z-10 max-w-6xl mx-auto h-full flex flex-col justify-center">
                        
                        <!-- Moderator (Top Center) -->
                        <div class="flex justify-center mb-8">
                            <div id="moderator-seat" class="participant-card opacity-0 transition-all duration-700">
                                <!-- Injected via JS -->
                            </div>
                        </div>

                        <!-- Critics (Arc) -->
                        <div id="critics-arc" class="flex justify-center gap-8 items-start perspective-1000">
                            <!-- Injected via JS -->
                             <div class="text-slate-500 text-sm italic">Waiting for roundtable assembly...</div>
                        </div>

                    </div>
                    
                    <!-- Floating Particles/Effects -->
                    <div id="particles" class="absolute inset-0 pointer-events-none"></div>
                </div>

                <!-- Split Content -->
                <div class="flex-1 flex overflow-hidden">
                    <!-- Left: Activity Stream (Chat Style) -->
                    <div class="w-1/2 flex flex-col border-r border-gray-200 dark:border-slate-800 bg-white dark:bg-slate-900 transition-colors duration-200">
                        <div class="p-3 border-b border-gray-100 dark:border-slate-800 bg-gray-50 dark:bg-slate-950 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                            Roundtable Discussion
                        </div>
                        <div id="activityLog" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50 dark:bg-slate-900/50">
                            <!-- Activity items will be injected here as chat bubbles -->
                        </div>
                        <!-- Metrics Footer -->
                        <div class="p-3 bg-white dark:bg-slate-900 border-t border-gray-200 dark:border-slate-800 text-xs text-gray-400 flex justify-between">
                            <span><i class="fa-solid fa-coins"></i> Tokens: <span id="totalTokens">0</span></span>
                            <span><i class="fa-solid fa-bug"></i> Med Issues: <span id="mediumIssues">0</span></span>
                        </div>
                    </div>

                    <!-- Right: Live Preview / Context -->
                    <div class="w-1/2 flex flex-col bg-white dark:bg-slate-900 transition-colors duration-200">
                         <div class="p-3 border-b border-gray-100 dark:border-slate-800 bg-gray-50 dark:bg-slate-950 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider flex justify-between items-center">
                            <span>Live Artifact Preview</span>
                            <span class="text-xs text-gray-400">Read Only</span>
                        </div>
                        <div class="flex-1 overflow-y-auto p-6 prose prose-sm dark:prose-invert max-w-none">
                            <div class="opacity-50 text-center mt-20">
                                <i class="fa-regular fa-file-lines text-4xl mb-3 text-gray-300 dark:text-slate-600"></i>
                                <p class="dark:text-slate-500">Content updates will appear here as the moderator refines the document.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: RESULTS (Finished) -->
            <div id="resultsCard" class="hidden h-full flex flex-col max-w-5xl mx-auto w-full">
                 <div class="mb-6 flex justify-between items-end">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Refinement Complete</h2>
                        <p class="text-slate-500 dark:text-slate-400 text-sm">Your document has been optimized by the roundtable.</p>
                    </div>
                    <div class="flex gap-3">
                        <button id="viewReportBtn" class="px-4 py-2 bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 rounded-lg text-sm font-medium hover:bg-gray-50 dark:hover:bg-slate-700 dark:text-slate-200 transition shadow-sm">
                            <i class="fa-solid fa-chart-pie mr-1"></i> Convergence Report
                        </button>
                        <button id="viewReviewsBtn" class="px-4 py-2 bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 rounded-lg text-sm font-medium hover:bg-gray-50 dark:hover:bg-slate-700 dark:text-slate-200 transition shadow-sm">
                            <i class="fa-solid fa-list-check mr-1"></i> View All Reviews
                        </button>
                        <button onclick="window.print()" class="px-4 py-2 bg-brand-600 text-white rounded-lg text-sm font-medium hover:bg-brand-700 transition shadow-sm">
                            <i class="fa-solid fa-download mr-1"></i> Export / Print
                        </button>
                    </div>
                </div>

                <div class="bg-white dark:bg-slate-900 rounded-xl shadow-lg border border-gray-200 dark:border-slate-800 flex-1 overflow-hidden flex flex-col transition-colors duration-200">
                    <div class="bg-gray-50 dark:bg-slate-950 border-b border-gray-200 dark:border-slate-800 px-6 py-3 flex items-center justify-between">
                        <span class="text-sm font-semibold text-gray-700 dark:text-slate-300">Final Document</span>
                        <div class="flex gap-2">
                             <span class="w-3 h-3 rounded-full bg-red-400"></span>
                             <span class="w-3 h-3 rounded-full bg-yellow-400"></span>
                             <span class="w-3 h-3 rounded-full bg-green-400"></span>
                        </div>
                    </div>
                    <div id="prdContent" class="flex-1 overflow-y-auto p-8 prose prose-slate dark:prose-invert max-w-none">
                        <!-- Final Content -->
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Modal for Reports & Reviews -->
    <div id="detailsModal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-50 hidden flex items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="bg-white dark:bg-slate-900 w-full max-w-4xl h-[85vh] rounded-2xl shadow-2xl flex flex-col transform scale-95 transition-transform duration-300 overflow-hidden border border-gray-200 dark:border-slate-700" id="detailsModalContent">
            <!-- Header -->
            <div class="p-6 border-b border-gray-100 dark:border-slate-800 flex justify-between items-center bg-gray-50 dark:bg-slate-950">
                <div>
                    <h3 class="text-xl font-bold text-slate-900 dark:text-white" id="modalTitle">Details</h3>
                    <p class="text-sm text-slate-500 dark:text-slate-400" id="modalSubtitle">Session Analysis</p>
                </div>
                <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-white dark:bg-slate-800 hover:bg-gray-100 dark:hover:bg-slate-700 flex items-center justify-center text-slate-500 transition shadow-sm border border-gray-200 dark:border-slate-700">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            
            <!-- Content -->
            <div id="modalBody" class="flex-1 overflow-y-auto p-8 bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-200">
                <!-- Dynamic Content -->
            </div>

            <!-- Footer -->
            <div class="p-4 border-t border-gray-100 dark:border-slate-800 bg-gray-50 dark:bg-slate-950 flex justify-end">
                <button onclick="closeModal()" class="px-4 py-2 bg-white dark:bg-slate-800 border border-gray-300 dark:border-slate-600 rounded-lg text-sm font-medium hover:bg-gray-50 dark:hover:bg-slate-700 transition text-slate-700 dark:text-slate-300">Close</button>
            </div>
        </div>
    </div>

    <script src="/static/js/websocket.js"></script>
    <script src="/static/js/visualization.js"></script>
    <script src="/static/js/app.js"></script>
    <script>
        // Simple view switcher
        function showView(viewId) {
            ['setupView', 'monitorView', 'resultsCard'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(viewId).classList.remove('hidden');
        }
    </script>
</body>
</html>